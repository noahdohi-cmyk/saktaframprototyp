<!DOCTYPE html>
<html>
<head>
  <title>SaktaFram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { height:100%; width:100%; }

    /* Themes */
    body.light { background:#f0f0f0; }
    body.dark { background:#121212; color:white; }

    /* Search & buttons */
    #searchBox {
      position:absolute; top:20px; left:50%; transform:translateX(-50%);
      z-index:1000; background: rgba(255,255,255,0.95); padding:12px;
      border-radius:12px; display:flex; gap:10px; box-shadow:0 4px 12px rgba(0,0,0,0.3);
      transition: opacity 0.4s ease;
    }
    #searchBox.hide { opacity:0; pointer-events:none; }
    #searchBox input { padding:8px 12px; width:200px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
    #searchBox button {
      padding:8px 16px; border:none; border-radius:8px;
      background:#007bff; color:white; font-weight:bold; cursor:pointer; transition: background 0.2s, opacity 0.4s;
    }
    #searchBox button:hover { background:#0056b3; }
    #startNav { display:none; opacity:0; }

    /* Bottom-bar */
    #bottomBar {
      position:absolute; bottom:-60px; left:0; width:100%;
      background: rgba(0,0,0,0.8); color:white; padding:12px;
      display:flex; justify-content: space-around; font-weight:bold;
      font-size:16px; z-index:1000;
      border-top-left-radius:12px; border-top-right-radius:12px;
      transition: bottom 0.5s ease;
    }
    #bottomBar.show { bottom:0; }

    /* Version tag */
    #versionTag {
      position:absolute; top:10px; left:10px;
      background: rgba(0,0,0,0.7); color:white; padding:5px 10px;
      font-weight:bold; border-radius:5px; z-index:1001;
    }

    /* Pulsing marker */
    .pulsingMarker {
      width:20px; height:20px;
      background: rgba(0,150,255,0.7);
      border-radius:50%;
      box-shadow:0 0 15px rgba(0,150,255,0.5);
      animation:pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(0.8); opacity:0.7; }
      50% { transform: scale(1.3); opacity:0.4; }
      100% { transform: scale(0.8); opacity:0.7; }
    }

    /* Autocomplete suggestions */
    #suggestions {
      position:absolute; top:58px; left:50%; transform:translateX(-50%);
      background:white; z-index:1002; border-radius:8px; width:220px;
      max-height:200px; overflow-y:auto; box-shadow:0 2px 8px rgba(0,0,0,0.3); display:none;
    }
    .suggestionItem { padding:6px 10px; cursor:pointer; }
    .suggestionItem:hover { background:#e0e0e0; }

    /* Return to me button */
    #returnBtn {
      position:absolute; bottom:80px; right:20px; z-index:1002;
      background:#007bff; color:white; border:none; border-radius:50%; width:50px; height:50px;
      font-size:24px; display:none; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);
      transition: opacity 0.3s;
    }
  </style>
</head>
<body class="light">
<div id="versionTag">Version 1.0</div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Adress eller plats" oninput="autocomplete()">
  <button id="searchBtn" onclick="searchPlace()">Sök</button>
  <button id="startNav" onclick="startNavigation()">Påbörja</button>
</div>
<div id="suggestions"></div>
<button id="returnBtn" onclick="returnToMe()">↑</button>

<div id="map"></div>

<div id="bottomBar">
  <div>Ankomst: <span id="arrivalTime">--:--</span></div>
  <div>Tid kvar: <span id="timeLeft">-- min</span></div>
  <div>Kvar: <span id="distanceLeft">-- km</span></div>
  <div>Hastighet: <span id="speed">-- km/h</span></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

<script>
var map = L.map('map',{zoomControl:false, dragging:true, touchZoom:true, scrollWheelZoom:true, doubleClickZoom:false}).setView([63.83,20.26],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

var userIcon = L.divIcon({className:'pulsingMarker', iconSize:[20,20], iconAnchor:[10,10]});
var userMarker = null;
var routeData=null;
var navActive=false;
var lastPos=null;

var routingControl = L.Routing.control({
  waypoints:[],
  lineOptions:{styles:[{color:'blue', opacity:0.6, weight:5}]},
  router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
  routeWhileDragging:false,
  addWaypoints:false,
  show:false
}).addTo(map);

// Autocomplete
function autocomplete(){
  let query = document.getElementById('searchInput').value;
  if(!query) { document.getElementById('suggestions').style.display='none'; return; }
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&viewbox=${map.getBounds().toBBoxString()}&bounded=1`)
    .then(resp=>resp.json()).then(data=>{
      let sug = document.getElementById('suggestions');
      sug.innerHTML='';
      data.forEach(item=>{
        let div = document.createElement('div');
        div.className='suggestionItem';
        div.textContent = item.display_name;
        div.onclick=()=>{ document.getElementById('searchInput').value=item.display_name; sug.style.display='none'; searchPlace(); };
        sug.appendChild(div);
      });
      sug.style.display=data.length>0? 'block':'none';
    });
}

// Live-position
function updatePosition(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      let lat=pos.coords.latitude, lng=pos.coords.longitude;
      let currentLatLng=L.latLng(lat,lng);

      if(!userMarker){ userMarker=L.marker(currentLatLng,{icon:userIcon, rotationAngle:0}).addTo(map); }
      else { userMarker.setLatLng(currentLatLng); }

      let speed = pos.coords.speed? (pos.coords.speed*3.6).toFixed(1) : '--';
      document.getElementById('speed').textContent = speed;

      if(navActive){
        lastPos=currentLatLng;
        updateBottomBar([lat,lng]);
        updateMarkerRotation(currentLatLng);
      }
    });
  }
}
setInterval(updatePosition,500);

function updateMarkerRotation(currentLatLng){
  if(!routeData || !routeData.coordinates || routeData.coordinates.length<2) return;
  let closestIndex = 0;
  let minDist = Infinity;
  routeData.coordinates.forEach((c,i)=>{
    let d = currentLatLng.distanceTo(L.latLng(c[1],c[0]));
    if(d<minDist){ minDist=d; closestIndex=i; }
  });
  let nextLatLng = L.latLng(routeData.coordinates[Math.min(closestIndex+1,routeData.coordinates.length-1)][1],
                            routeData.coordinates[Math.min(closestIndex+1,routeData.coordinates.length-1)][0]);
  let angle = Math.atan2(nextLatLng.lng-currentLatLng.lng, nextLatLng.lat-currentLatLng.lat)*180/Math.PI;
  userMarker.setRotationAngle(angle);
}

// Search & route
function searchPlace(){
  document.getElementById('suggestions').style.display='none';
  let query=document.getElementById('searchInput').value;
  if(!query) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(resp=>resp.json()).then(data=>{
      if(data.length>0){
        let lat=parseFloat(data[0].lat), lon=parseFloat(data[0].lon);
        L.marker([lat,lon]).addTo(map).bindPopup(query).openPopup();

        let currentPos = userMarker.getLatLng();
        routingControl.setWaypoints([currentPos,L.latLng(lat,lon)]);
        routingControl.on('routesfound', function(e){ routeData = e.routes[0]; displayRouteInfo(routeData); });

        let startBtn=document.getElementById('startNav'); startBtn.style.display='inline-block';
        setTimeout(()=>startBtn.style.opacity=1,50);
      } else { alert("Plats hittades inte."); }
    });
}

// Bottom-bar
function displayRouteInfo(route){
  if(!route) return;
  let distance=route.summary.totalDistance/1000;
  let time=distance/30*60;
  let now=new Date(), arrival=new Date(now.getTime()+time*60000);
  document.getElementById('arrivalTime').textContent = `${arrival.getHours().toString().padStart(2,'0')}:${arrival.getMinutes().toString().padStart(2,'0')}`;
  document.getElementById('timeLeft').textContent = `${time.toFixed(0)} min`;
  document.getElementById('distanceLeft').textContent = `${distance.toFixed(1)} km`;
}

// Start navigation
function startNavigation(){
  if(!routeData) return;
  navActive=true;
  document.getElementById('bottomBar').classList.add('show');
  map.flyTo(userMarker.getLatLng(), map.getMaxZoom(), {animate:true, duration:1.5});
  document.getElementById('searchBox').classList.add('hide');
}

// Return to me button
function returnToMe(){
  if(lastPos) map.flyTo(lastPos,map.getMaxZoom(),{animate:true});
  document.getElementById('returnBtn').style.display='none';
}

// Show return button if map moved
map.on('dragstart zoomstart', function(){ if(navActive) document.getElementById('returnBtn').style.display='block'; });

// Update bottom-bar
function updateBottomBar(currentPos){
  if(!routeData || !routeData.coordinates || routeData.coordinates.length<2) return;
  let currentLatLng=L.latLng(currentPos[0],currentPos[1]);
  let lastPoint=routeData.coordinates[routeData.coordinates.length-1];
  let lastLatLng=L.latLng(lastPoint[1],lastPoint[0]);
  let kmLeft = currentLatLng.distanceTo(lastLatLng)/1000;
  let timeLeft = kmLeft/30*60;
  let now=new Date();
  let arrival=new Date(now.getTime()+timeLeft*60000);
  document.getElementById('arrivalTime').textContent = `${arrival.getHours().toString().padStart(2,'0')}:${arrival.getMinutes().toString().padStart(2,'0')}`;
  document.getElementById('timeLeft').textContent = `${timeLeft.toFixed(0)} min`;
  document.getElementById('distanceLeft').textContent = `${kmLeft.toFixed(1)} km`;
}
</script>
</body>
</html>
