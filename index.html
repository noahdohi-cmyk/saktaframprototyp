<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SaktaFram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<style>
html,body{margin:0;height:100%;font-family:sans-serif;}
#map{height:100%;width:100%;}

#version{
  position:absolute;top:10px;left:10px;
  background:#000a;color:#fff;
  padding:6px 10px;border-radius:6px;
  z-index:1000;font-weight:bold;
}

#search{
  position:absolute;top:20px;left:50%;
  transform:translateX(-50%);
  background:#fff;border-radius:10px;
  padding:10px;display:flex;gap:8px;
  z-index:1000;
}
#search input{padding:6px;font-size:16px}
#search button{padding:6px 10px;font-weight:bold}

#bottomBar{
  position:absolute;bottom:0;left:0;width:100%;
  background:#000d;color:#fff;
  display:flex;justify-content:space-around;
  padding:12px 0;font-size:15px;
  z-index:1000;
}

#endBtn{
  position:absolute;right:20px;bottom:90px;
  width:50px;height:50px;border-radius:50%;
  background:#c00;color:#fff;
  border:none;font-size:18px;
  display:none;z-index:1000;
}

/* Blob */
.blob{
  width:20px;height:20px;
  background:#2fa4ff;
  border-radius:50%;
  box-shadow:0 0 15px #2fa4ff;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{transform:scale(.8);opacity:.7}
  50%{transform:scale(1.3);opacity:.4}
  100%{transform:scale(.8);opacity:.7}
}
</style>
</head>

<body>
<div id="version">Version 1.12</div>

<div id="search">
  <input id="dest" placeholder="Adress eller plats">
  <button onclick="search()">S√∂k</button>
  <button onclick="startNav()">P√•b√∂rja</button>
</div>

<button id="endBtn" onclick="endNav()">‚úï</button>

<div id="map"></div>

<div id="bottomBar">
  <div>‚è∞ <span id="arrival">--:--</span></div>
  <div>‚è≥ <span id="time">-- min</span></div>
  <div>üõ£ <span id="dist">-- km</span></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
const map=L.map('map',{zoomControl:false}).setView([63.83,20.26],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let userPos=null, blob=null, route=null, nav=false;

const blobIcon=L.divIcon({
  className:'blob',
  iconSize:[20,20],
  iconAnchor:[10,10]
});

const routing=L.Routing.control({
  waypoints:[],
  lineOptions:{styles:[{color:'#1e90ff',weight:6}]},
  show:false,
  addWaypoints:false
}).addTo(map);

/* GPS */
setInterval(()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    userPos=L.latLng(p.coords.latitude,p.coords.longitude);
    if(nav && blob) blob.setLatLng(userPos);
    if(nav && route) updateBar();
  });
},500);

/* Search */
function search(){
  const q=document.getElementById('dest').value;
  if(!q||!userPos)return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
  .then(r=>r.json()).then(d=>{
    if(!d.length)return;
    routing.setWaypoints([userPos,L.latLng(d[0].lat,d[0].lon)]);
    routing.on('routesfound',e=>route=e.routes[0]);
  });
}

/* Start */
function startNav(){
  if(!route||!userPos)return;
  nav=true;
  map.flyTo(userPos,18,{duration:1.4});

  setTimeout(()=>{
    blob=L.marker(userPos,{icon:blobIcon}).addTo(map);
  },1400);

  document.getElementById('endBtn').style.display='block';
}

/* End */
function endNav(){
  nav=false;
  if(blob){map.removeLayer(blob);blob=null;}
  routing.setWaypoints([]);
  route=null;
  document.getElementById('endBtn').style.display='none';
}

/* Bottom bar */
function updateBar(){
  const end=route.coordinates.at(-1);
  const km=userPos.distanceTo(L.latLng(end[1],end[0]))/1000;
  const min=km/30*60;
  const eta=new Date(Date.now()+min*60000);

  document.getElementById('dist').textContent=km.toFixed(1)+' km';
  document.getElementById('time').textContent=min.toFixed(0)+' min';
  document.getElementById('arrival').textContent=
    eta.getHours().toString().padStart(2,'0')+':' +
    eta.getMinutes().toString().padStart(2,'0');
}
</script>
</body>
</html>
