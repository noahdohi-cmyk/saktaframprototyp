<!DOCTYPE html>
<html>
<head>
<title>SaktaFram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
html,body{margin:0;padding:0;height:100%;font-family:sans-serif;}
#map{height:100%;width:100%;}

/* Panels */
.panel{
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(8px);
  border-radius:12px;
  padding:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}

/* Search */
#searchBox{
  position:absolute;top:20px;left:50%;
  transform:translateX(-50%);
  display:flex;gap:10px;
  z-index:1000;
}
#searchBox.hide{opacity:0;pointer-events:none;}
#searchBox input{
  padding:8px 12px;width:200px;
  border-radius:8px;border:1px solid #ccc;
  font-size:16px;
}
#searchBox button{
  padding:8px 16px;border:none;
  border-radius:8px;
  background:#007bff;color:white;
  font-weight:bold;cursor:pointer;
}

/* Buttons */
#endNav,#returnBtn{
  position:absolute;right:20px;
  width:50px;height:50px;
  border-radius:50%;
  border:none;font-size:22px;
  color:white;cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:1001;display:none;
}
#endNav{bottom:150px;background:#dc3545;}
#returnBtn{bottom:80px;background:#007bff;}

/* Bottom bar */
#bottomBar{
  position:absolute;bottom:-70px;left:0;
  width:100%;background:rgba(0,0,0,.85);
  color:white;display:flex;
  justify-content:space-around;
  padding:14px 0;font-weight:bold;
  border-top-left-radius:14px;
  border-top-right-radius:14px;
  transition:.4s;z-index:1000;
}
#bottomBar.show{bottom:0;}
.bottomItem{display:flex;flex-direction:column;align-items:center;font-size:14px}

/* Version */
#versionTag{
  position:absolute;top:10px;left:10px;
  background:rgba(0,0,0,.7);
  color:white;padding:5px 10px;
  border-radius:6px;font-weight:bold;
  z-index:1000;
}

/* Blob */
.pulsingMarker{
  width:20px;height:20px;
  background:rgba(0,150,255,.8);
  border-radius:50%;
  box-shadow:0 0 15px rgba(0,150,255,.6);
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{transform:scale(.8);opacity:.7}
  50%{transform:scale(1.3);opacity:.4}
  100%{transform:scale(.8);opacity:.7}
}

/* Next step arrow */
#nextStepArrow{
  position:absolute;
  top:90px;left:50%;
  transform:translateX(-50%);
  display:none;
  flex-direction:column;
  align-items:center;
  z-index:1002;
}
#nextStepArrow i{
  font-size:48px;
  color:#007bff;
}
#nextStepArrow span{
  margin-top:6px;
  background:rgba(0,0,0,.7);
  color:white;
  padding:4px 10px;
  border-radius:12px;
  font-weight:bold;
}
</style>
</head>

<body>
<div id="versionTag">Version 1.12</div>

<div id="searchBox" class="panel">
  <input id="searchInput" placeholder="Adress eller plats">
  <button onclick="searchPlace()"><i class="fa fa-search"></i></button>
  <button onclick="startNavigation()"><i class="fa fa-play"></i></button>
</div>

<button id="endNav" onclick="endNavigation()"><i class="fa fa-stop"></i></button>
<button id="returnBtn" onclick="returnToMe()"><i class="fa fa-location-arrow"></i></button>

<div id="nextStepArrow">
  <i id="arrowIcon" class="fa fa-arrow-up"></i>
  <span id="arrowText">-- m</span>
</div>

<div id="map"></div>

<div id="bottomBar">
  <div class="bottomItem">‚è∞ <span id="arrivalTime">--:--</span></div>
  <div class="bottomItem">‚è≥ <span id="timeLeft">-- min</span></div>
  <div class="bottomItem">üõ£ <span id="distanceLeft">-- km</span></div>
  <div class="bottomItem">üöú <span id="speed">-- km/h</span></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
const map=L.map('map',{zoomControl:false}).setView([63.83,20.26],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let lastPos=null, navActive=false, routeData=null;
let userBlob=null;

const userIcon=L.divIcon({
  className:'pulsingMarker',
  iconSize:[20,20],
  iconAnchor:[10,10]
});

const routing=L.Routing.control({
  waypoints:[],
  router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
  show:false,
  addWaypoints:false
}).addTo(map);

/* GPS */
setInterval(()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude;
    lastPos=L.latLng(lat,lng);

    if(navActive && userBlob){
      userBlob.setLatLng(lastPos);
      updateArrow();
      updateBottomBar();
    }

    document.getElementById('speed').textContent=
      pos.coords.speed?(pos.coords.speed*3.6).toFixed(1):'--';
  });
},500);

/* Navigation */
function startNavigation(){
  if(!routeData||!lastPos)return;
  navActive=true;

  map.flyTo(lastPos,map.getMaxZoom(),{duration:1.5});

  setTimeout(()=>{
    userBlob=L.marker(lastPos,{icon:userIcon}).addTo(map);
    document.getElementById('nextStepArrow').style.display='flex';
  },1500);

  document.getElementById('searchBox').classList.add('hide');
  document.getElementById('bottomBar').classList.add('show');
  document.getElementById('endNav').style.display='block';
  document.getElementById('returnBtn').style.display='block';
}

function endNavigation(){
  navActive=false;
  if(userBlob){map.removeLayer(userBlob);userBlob=null;}
  routing.setWaypoints([]);
  routeData=null;
  document.getElementById('nextStepArrow').style.display='none';
  document.getElementById('bottomBar').classList.remove('show');
  document.getElementById('searchBox').classList.remove('hide');
  document.getElementById('endNav').style.display='none';
  document.getElementById('returnBtn').style.display='none';
}

function returnToMe(){
  if(lastPos) map.flyTo(lastPos,map.getZoom());
}

/* Search */
function searchPlace(){
  const q=document.getElementById('searchInput').value;
  if(!q||!lastPos)return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
  .then(r=>r.json()).then(d=>{
    if(!d.length)return;
    routing.setWaypoints([lastPos,L.latLng(d[0].lat,d[0].lon)]);
    routing.on('routesfound',e=>{routeData=e.routes[0];});
  });
}

/* Arrow logic */
function updateArrow(){
  if(!routeData||!routeData.instructions)return;
  const inst=routeData.instructions.find(i=>i.distance>5);
  if(!inst)return;

  let icon='fa-arrow-up';
  if(inst.text.includes('v√§nster')) icon='fa-arrow-left';
  if(inst.text.includes('h√∂ger')) icon='fa-arrow-right';

  document.getElementById('arrowIcon').className='fa '+icon;
  document.getElementById('arrowText').textContent=Math.round(inst.distance)+' m';
}

/* Bottom bar */
function updateBottomBar(){
  const end=routeData.coordinates.at(-1);
  const km=lastPos.distanceTo(L.latLng(end[1],end[0]))/1000;
  const min=km/30*60;
  const arr=new Date(Date.now()+min*60000);

  document.getElementById('distanceLeft').textContent=km.toFixed(1)+' km';
  document.getElementById('timeLeft').textContent=min.toFixed(0)+' min';
  document.getElementById('arrivalTime').textContent=
    arr.getHours().toString().padStart(2,'0')+':'+arr.getMinutes().toString().padStart(2,'0');
}
</script>
</body>
</html>
