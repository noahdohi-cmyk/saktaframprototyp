<!DOCTYPE html>
<html>
<head>
  <title>SaktaFram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; }
    #map { height: 100%; width: 100%; }

    #searchBox {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: white; padding: 8px; border-radius: 5px;
      display: flex; gap: 5px;
    }
    #searchBox input { padding:5px; width:180px; }
    #searchBox button { padding:5px; }

    #bottomBar {
      position: absolute; bottom:0; left:0; width:100%;
      background: rgba(0,0,0,0.7); color:white; padding:8px;
      font-family: sans-serif; display:flex; justify-content: space-around;
      z-index: 1000;
    }

    #versionTag {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 8px;
      font-weight: bold;
      border-radius: 5px;
      z-index: 1001;
      font-family: sans-serif;
    }

    /* Pulserande blob */
    .pulsingMarker {
      width: 20px;
      height: 20px;
      background: rgba(0, 150, 255, 0.7);
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0,150,255,0.5);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      50% { transform: scale(1.3); opacity: 0.4; }
      100% { transform: scale(0.8); opacity: 0.7; }
    }
  </style>
</head>
<body>
<div id="versionTag">Version 1.0</div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Adress eller plats, t.ex. ICA">
  <button onclick="searchPlace()">Sök</button>
  <button id="startNav" onclick="startNavigation()" disabled>Påbörja</button>
</div>

<div id="map"></div>

<div id="bottomBar" style="display:none;">
  <div>Ankomst: <span id="arrivalTime">--:--</span></div>
  <div>Tid kvar: <span id="timeLeft">-- min</span></div>
  <div>Kvar: <span id="distanceLeft">-- km</span></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

<script>
var map = L.map('map', {
  zoomControl: false,
  dragging: true,
  touchZoom: true,
  scrollWheelZoom: false,
  doubleClickZoom: false
}).setView([63.83, 20.26], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// Pulserande markör med rotation
var userIcon = L.divIcon({ className: 'pulsingMarker', iconSize: [20, 20] });
var userMarker = L.marker([0,0], {icon: userIcon, rotationAngle:0}).addTo(map);

var routingControl = L.Routing.control({
  waypoints: [],
  lineOptions: { styles: [{color: 'blue', opacity: 0.6, weight: 5}] },
  router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
  routeWhileDragging: false,
  addWaypoints: false,
  show: false
}).addTo(map);

var routeData = null;
var navActive = false;

// Uppdatera live-position och marker rotation
function updatePosition() {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      var currentLatLng = L.latLng(lat, lng);
      userMarker.setLatLng(currentLatLng);

      if(navActive){
        map.setView(currentLatLng, map.getZoom(), {animate:true});
        updateBottomBar([lat,lng]);
        updateMarkerRotation(currentLatLng);
      }
    });
  }
}
setInterval(updatePosition, 500);

// Rotation av markör mot nästa punkt
function updateMarkerRotation(currentLatLng){
  if(!routeData) return;
  var coords = routeData.coordinates;
  if(coords.length < 2) return;
  var next = coords[1];
  var nextLatLng = L.latLng(next[1], next[0]);
  var angle = Math.atan2(nextLatLng.lng - currentLatLng.lng, nextLatLng.lat - currentLatLng.lat) * 180/Math.PI;
  userMarker.setRotationAngle(angle);
}

// Sök destination
function searchPlace(){
  var query = document.getElementById('searchInput').value;
  if(!query) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(resp=>resp.json())
    .then(data=>{
      if(data.length>0){
        var lat = parseFloat(data[0].lat);
        var lon = parseFloat(data[0].lon);
        L.marker([lat, lon]).addTo(map).bindPopup(query).openPopup();
        var currentPos = userMarker.getLatLng();
        routingControl.setWaypoints([currentPos, L.latLng(lat, lon)]);
        routingControl.on('routesfound', function(e){
          routeData = e.routes[0];
          displayRouteInfo(routeData);
        });
        document.getElementById('startNav').disabled = false;
      } else {
        alert("Plats hittades inte.");
      }
    });
}

// Visa restid/distans/ankomst
function displayRouteInfo(route){
  var distance = route.summary.totalDistance/1000;
  var time = distance/30*60;
  var now = new Date();
  var arrival = new Date(now.getTime() + time*60000);
  var hours = arrival.getHours().toString().padStart(2,'0');
  var mins = arrival.getMinutes().toString().padStart(2,'0');
  alert(`Distans: ${distance.toFixed(1)} km\nTid: ${time.toFixed(0)} min\nAnkomst: ${hours}:${mins}`);
}

// Starta navigering
function startNavigation(){
  if(!routeData) return;
  navActive = true;
  document.getElementById('bottomBar').style.display='flex';
  map.flyTo(userMarker.getLatLng(), 18, {animate:true, duration:2});
}

// Uppdatera bottom bar med korrekt avstånd
function updateBottomBar(currentPos){
  if(!routeData) return;
  var currentLatLng = L.latLng(currentPos[0], currentPos[1]);
  var lastPoint = routeData.coordinates[routeData.coordinates.length-1];
  var lastLatLng = L.latLng(lastPoint[1], lastPoint[0]);
  
  var kmLeft = currentLatLng.distanceTo(lastLatLng)/1000;
  var timeLeft = kmLeft/30*60;
  var now = new Date();
  var arrival = new Date(now.getTime() + timeLeft*60000);
  var hours = arrival.getHours().toString().padStart(2,'0');
  var mins = arrival.getMinutes().toString().padStart(2,'0');

  document.getElementById('arrivalTime').textContent = `${hours}:${mins}`;
  document.getElementById('timeLeft').textContent = `${timeLeft.toFixed(0)} min`;
  document.getElementById('distanceLeft').textContent = `${kmLeft.toFixed(1)} km`;
}
</script>
</body>
</html>
