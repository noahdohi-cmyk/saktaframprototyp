<!DOCTYPE html>
<html>
<head>
<title>SaktaFram 1.14</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
#map { height:100%; width:100%; }
body.light { background:#f0f0f0; }
body.dark { background:#121212; color:white; }

/* Sökpanel */
#searchBox {
  position:absolute; top:20px; left:50%; transform:translateX(-50%);
  display:flex; gap:10px; z-index:1000; background:rgba(255,255,255,0.8); backdrop-filter:blur(8px);
  padding:10px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.3s ease;
}
#searchBox.hide { opacity:0; pointer-events:none; }
#searchBox input { padding:8px 12px; width:220px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
#searchBox button { padding:8px 16px; border:none; border-radius:8px;
  background:#007bff; color:white; font-weight:bold; cursor:pointer; transition:all 0.2s; }
#searchBox button:hover { transform:scale(1.05); background:#0056b3; }

/* Avsluta & Return */
#endNav, #returnBtn { position:absolute; z-index:1003; border:none; border-radius:50%;
  width:50px; height:50px; font-size:24px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);
  transition:all 0.3s ease; }
#endNav:hover, #returnBtn:hover { transform:scale(1.1); }
#endNav { bottom:150px; right:20px; background:#dc3545; color:white; }
#returnBtn { bottom:80px; right:20px; background:#007bff; color:white; }

/* Next-step pil */
#nextStep { position:absolute; top:50px; left:50%; transform:translateX(-50%);
  width:60px; height:60px; z-index:1003; display:flex; align-items:center; justify-content:center; }
#nextStep i { font-size:40px; color:#007bff; transition: transform 0.3s ease; }

/* Bottom bar större */
#bottomBar { position:absolute; bottom:-80px; left:0; width:100%; background: rgba(0,0,0,0.8); color:white;
  display:flex; justify-content: space-around; font-weight:bold; font-size:18px; z-index:1000;
  border-top-left-radius:16px; border-top-right-radius:16px; padding:16px 0; transition:bottom 0.5s ease; }
#bottomBar.show { bottom:0; }
.bottomItem { display:flex; flex-direction:column; align-items:center; gap:4px; }
.bottomItem i { font-size:20px; }

#versionTag { position:absolute; top:10px; left:10px; background: rgba(0,0,0,0.7); color:white;
  padding:5px 10px; font-weight:bold; border-radius:5px; z-index:1001; }

#suggestions { position:absolute; top:58px; left:50%; transform:translateX(-50%); background:white; z-index:1002;
  border-radius:8px; width:220px; max-height:200px; overflow-y:auto; box-shadow:0 2px 8px rgba(0,0,0,0.3); display:none; }
.suggestionItem { padding:6px 10px; cursor:pointer; }
.suggestionItem:hover { background:#e0e0e0; }
</style>
</head>
<body class="light">
<div id="versionTag">Version 1.14</div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Adress eller plats" oninput="autocomplete()">
  <button id="searchBtn" onclick="searchPlace()"><i class="fa fa-search"></i></button>
  <button id="startNav" onclick="startNavigation()"><i class="fa fa-play"></i></button>
</div>

<button id="endNav" onclick="endNavigation()"><i class="fa fa-stop"></i></button>
<button id="returnBtn" onclick="returnToMe()"><i class="fa fa-location-arrow"></i></button>

<div id="suggestions"></div>
<div id="nextStep"><i class="fa fa-arrow-up"></i></div>

<div id="map"></div>
<div id="bottomBar">
  <div class="bottomItem"><i class="fa fa-clock"></i><span id="arrivalTime">--:--</span></div>
  <div class="bottomItem"><i class="fa fa-hourglass-half"></i><span id="timeLeft">-- min</span></div>
  <div class="bottomItem"><i class="fa fa-road"></i><span id="distanceLeft">-- km</span></div>
  <div class="bottomItem"><i class="fa fa-tachometer-alt"></i><span id="speed">-- km/h</span></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
var map=L.map('map',{zoomControl:false, dragging:true, touchZoom:true, scrollWheelZoom:true}).setView([63.83,20.26],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

var routeData=null, navActive=false, lastPos=null, routeMarkers=[], routeLine=null;
var userMarker=null;

var routingControl=L.Routing.control({
  waypoints:[],
  lineOptions:{styles:[{color:'blue', opacity:0.6, weight:5}]},
  router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
  routeWhileDragging:false,
  addWaypoints:false,
  show:false
}).addTo(map);

// GPS
function updatePosition(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      let lat=pos.coords.latitude, lng=pos.coords.longitude;
      let currentLatLng=L.latLng(lat,lng);
      lastPos=currentLatLng;

      if(navActive){
        if(!userMarker){
          userMarker=L.marker(currentLatLng,{rotationAngle:0}).addTo(map);
        } else {
          userMarker.setLatLng(currentLatLng);
          // Rotera pil mot nästa punkt
          if(routeData && routeData.coordinates){
            let next=routeData.coordinates.find(c=>currentLatLng.distanceTo(L.latLng(c[1],c[0]))>1);
            if(next){
              let angle=Math.atan2(next[1]-lat,next[0]-lng)*180/Math.PI;
              userMarker.setRotationAngle(angle);
              document.getElementById('nextStep').firstChild.style.transform=`rotate(${angle}deg)`;
            }
          }
        }
        trimRouteLine(currentLatLng);
        updateBottomBar([lat,lng]);
      }
      let speed=pos.coords.speed?(pos.coords.speed*3.6).toFixed(1):'--';
      document.getElementById('speed').textContent=speed;
    });
  }
}
setInterval(updatePosition,500);

function trimRouteLine(currentLatLng){
  if(!routeData || !routeData.coordinates || !routeLine) return;
  let coords=routeData.coordinates.slice();
  let index=coords.findIndex(c=>currentLatLng.distanceTo(L.latLng(c[1],c[0]))>1);
  if(index>0) coords=coords.slice(index);
  routeLine.setLatLngs(coords.map(c=>[c[1],c[0]]));
}

function returnToMe(){ if(lastPos) map.flyTo(lastPos,map.getMaxZoom(),{animate:true}); }

function startNavigation(){
  if(!routeData || !lastPos) return;
  navActive=true;
  document.getElementById('bottomBar').classList.add('show');
  document.getElementById('searchBox').classList.add('hide');
  document.getElementById('endNav').style.display='inline-block';
  document.getElementById('returnBtn').style.display='inline-block';
  map.flyTo(lastPos,map.getMaxZoom(),{animate:true,duration:1.5});
  if(!userMarker) userMarker=L.marker(lastPos,{rotationAngle:0}).addTo(map);
}

function endNavigation(){
  navActive=false;
  document.getElementById('bottomBar').classList.remove('show');
  document.getElementById('endNav').style.display='none';
  document.getElementById('returnBtn').style.display='none';
  document.getElementById('searchBox').classList.remove('hide');
  routingControl.setWaypoints([]);
  routeMarkers.forEach(m=>map.removeLayer(m)); routeMarkers=[];
  if(routeLine) map.removeLayer(routeLine); routeLine=null;
  routeData=null;
}

function searchPlace(){
  let query=document.getElementById('searchInput').value;
  if(!query || !lastPos) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(resp=>resp.json()).then(data=>{
      if(data.length>0){
        routeMarkers.forEach(m=>map.removeLayer(m)); routeMarkers=[];
        let lat=parseFloat(data[0].lat), lon=parseFloat(data[0].lon);
        let m=L.marker([lat,lon]).addTo(map).bindPopup(query).openPopup(); routeMarkers.push(m);

        let startLatLng=lastPos;
        let destinationLatLng=L.latLng(lat,lon);

        routingControl.setWaypoints([startLatLng,destinationLatLng]);
        routingControl.on('routesfound', function(e){
          routeData = e.routes[0];
          if(routeLine) map.removeLayer(routeLine);
          routeLine=L.polyline(routeData.coordinates.map(c=>[c[1],c[0]]),{color:'blue',weight:5,opacity:0.6}).addTo(map);
          displayRouteInfo(routeData);
        });

        let startBtn=document.getElementById('startNav'); startBtn.style.display='inline-block';
        setTimeout(()=>startBtn.style.opacity=1,50);
      } else alert("Plats hittades inte.");
    });
}

function displayRouteInfo(route){
  if(!route) return;
  let distance=route.summary.totalDistance/1000; 
  let time=distance/30*60;
  let now=new Date(), arrival=new Date(now.getTime()+time*60000);
  document.getElementById('arrivalTime').textContent=`${arrival.getHours().toString().padStart(2,'0')}:${arrival.getMinutes().toString().padStart(2,'0')}`;
  document.getElementById('timeLeft').textContent=`${time.toFixed(0)} min`;
  document.getElementById('distanceLeft').textContent=`${distance.toFixed(1)} km`;
}

function updateBottomBar(currentPos){
  if(!routeData || !routeData.coordinates) return;
  let currentLatLng=L.latLng(currentPos[0],currentPos[1]);
  let lastPoint=routeData.coordinates[routeData.coordinates.length-1];
  let lastLatLng=L.latLng(lastPoint[1],lastPoint[0]);
  let kmLeft=currentLatLng.distanceTo(lastLatLng)/1000;
  let timeLeft=kmLeft/30*60;
  let now=new Date(); let arrival=new Date(now.getTime()+timeLeft*60000);
  document.getElementById('arrivalTime').textContent=`${arrival.getHours().toString().padStart(2,'0')}:${arrival.getMinutes().toString().padStart(2,'0')}`;
  document.getElementById('timeLeft').textContent=`${timeLeft.toFixed(0)} min`;
  document.getElementById('distanceLeft').textContent=`${kmLeft.toFixed(1)} km`;
}

// Autocomplete
function autocomplete(){
  let query=document.getElementById('searchInput').value;
  if(!query){ document.getElementById('suggestions').style.display='none'; return; }
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&viewbox=${map.getBounds().toBBoxString()}&bounded=1`)
    .then(resp=>resp.json()).then(data=>{
      let sug=document.getElementById('suggestions'); sug.innerHTML='';
      data.forEach(item=>{
        let div=document.createElement('div'); div.className='suggestionItem'; div.textContent=item.display_name;
        div.onclick=()=>{ document.getElementById('searchInput').value=item.display_name; sug.style.display='none'; searchPlace(); };
        sug.appendChild(div);
      });
      sug.style.display=data.length>0?'block':'none';
    });
}
</script>
</body>
</html>
